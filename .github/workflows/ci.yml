name: CI

on:
  push:
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake build-essential pkg-config \
            libpq-dev libpqxx-dev \
            libssl-dev librabbitmq-dev \
            nlohmann-json3-dev \
            libboost-system-dev libboost-thread-dev \
            curl
          sudo apt-get install -y git ca-certificates
          docker version
          docker compose version

      - name: Build orders-service
        working-directory: api-gateway/orders-service
        run: |
          cmake -S include -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j

      - name: Build payments-service
        working-directory: api-gateway/payments-service
        run: |
          cmake -S include -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j

      - name: Build websocket-service
        working-directory: api-gateway/websocket-service
        run: |
          cmake -S include -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: api-gateway/src/package-lock.json

      - name: Build frontend
        working-directory: api-gateway/src
        run: |
          npm ci
          npm run build

      - name: Compose up
        working-directory: api-gateway
        run: |
          docker compose up -d --build
          sleep 20

      - name: Smoke tests
        run: |
          curl -fsS http://localhost/health
          curl -fsS -X POST http://localhost/api/accounts \
            -H 'Content-Type: application/json' \
            -d '{"user_id":"ci_user"}' || true
          curl -fsS -X POST http://localhost/api/accounts/ci_user/deposit \
            -H 'Content-Type: application/json' \
            -d '{"amount":2000}' || true
          curl -fsS -X POST http://localhost/api/orders \
            -H 'Content-Type: application/json' \
            -d '{"user_id":"ci_user","amount":500,"description":"ci"}'

      - name: Compose logs (on failure)
        if: failure()
        working-directory: api-gateway
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Compose down
        if: always()
        working-directory: api-gateway
        run: docker compose down -v
