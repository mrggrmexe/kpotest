services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: adminpassword
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 30

  postgres-orders:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: orders_user
      POSTGRES_PASSWORD: orders_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 30

  postgres-payments:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: payments_user
      POSTGRES_PASSWORD: payments_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 30

  orders-service:
    build:
      context: ./orders-service
      dockerfile: include/Dockerfile
    environment:
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: "8080"

      DB_HOST: postgres-orders
      DB_PORT: "5432"
      DB_NAME: orders_db
      DB_USER: orders_user
      DB_PASSWORD: orders_password

      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: adminpassword
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-orders:
        condition: service_healthy
    restart: on-failure

  payments-service:
    build:
      context: ./payments-service
      dockerfile: include/Dockerfile
    environment:
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: "8080"

      DB_HOST: postgres-payments
      DB_PORT: "5432"
      DB_NAME: payments_db
      DB_USER: payments_user
      DB_PASSWORD: payments_password

      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: adminpassword
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-payments:
        condition: service_healthy
    restart: on-failure

  websocket-service:
    build:
      context: ./websocket-service
      dockerfile: include/Dockerfile
    environment:
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: "8080"

      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: adminpassword
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: on-failure

  frontend:
    build:
      context: ./src
      dockerfile: Dockerfile

  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      orders-service:
        condition: service_started
      payments-service:
        condition: service_started
      websocket-service:
        condition: service_started
    ports:
      - "80:80"
